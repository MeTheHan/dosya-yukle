<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MTechno - S√ºreli Dosya Y√ºkleme</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #111;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      padding-top: 40px;
    }
    h1 { color: #00d084; }
    input, button {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      border: none;
    }
    button {
      background-color: #00d084;
      color: black;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      background-color: #03c477;
    }
    #status a {
      color: #00d084;
    }
    ul {
      list-style: none;
      padding: 0;
      margin-top: 20px;
      width: 80%;
      max-width: 600px;
    }
    li {
      background: #222;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      word-wrap: break-word;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    a {
      color: #00d084;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .login-prompt {
      text-align: center;
      margin-top: 50px;
    }
    .login-prompt a {
      color: #00d084;
      font-weight: bold;
    }
    .user-info {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #222;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
    }
    .logout-btn {
      background: #ff4757;
      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
    }
    .file-actions {
      display: flex;
      gap: 10px;
    }
    .delete-btn {
      background: #ff4757;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .hidden {
      display: none;
    }
    .storage-info {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
      width: 80%;
      max-width: 600px;
    }
    .storage-bar {
      width: 100%;
      height: 10px;
      background: #555;
      border-radius: 5px;
      margin: 5px 0;
      overflow: hidden;
    }
    .storage-used {
      height: 100%;
      background: #00d084;
      border-radius: 5px;
      transition: width 0.3s;
    }
    .subscription-status {
      margin-top: 10px;
      padding: 8px;
      border-radius: 6px;
      font-size: 14px;
    }
    .subscription-good {
      background: #1e3a1e;
      color: #00d084;
      border: 1px solid #00d084;
    }
    .subscription-warning {
      background: #3a2e1e;
      color: #ffa502;
      border: 1px solid #ffa502;
    }
    .subscription-critical {
      background: #3a1e1e;
      color: #ff4757;
      border: 1px solid #ff4757;
    }
    .extend-btn {
      background: #00d084;
      color: black;
      padding: 8px 15px;
      font-size: 12px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 8px;
    }
    .extend-btn:hover {
      background: #03c477;
      transform: scale(1.05);
    }
    .progress-container {
      width: 100%;
      max-width: 600px;
      margin: 15px 0;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #555;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00d084, #03c477);
      border-radius: 10px;
      transition: width 0.3s ease;
      width: 0%;
    }
    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      font-size: 12px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
  </style>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Kullanƒ±cƒ± Bilgisi -->
  <div id="userInfo" class="user-info hidden">
    <span id="userEmail"></span>
    <button class="logout-btn" onclick="logout()">√áƒ±kƒ±≈ü</button>
  </div>

  <!-- Progress Bar -->
  <div class="progress-container hidden" id="progressContainer">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
      <div class="progress-text" id="progressText">0%</div>
    </div>
  </div>

  <!-- Giri≈ü Yapƒ±lmamƒ±≈üsa -->
  <div id="loginPrompt" class="login-prompt">
    <h1>üîê S√ºreli Dosya Y√ºkleme</h1>
    <p>Dosya y√ºklemek i√ßin giri≈ü yapmalƒ±sƒ±nƒ±z</p>
    <a href="https://methehan.github.io/login/">Giri≈ü Yap</a>
  </div>

  <!-- Giri≈ü Yapƒ±lmƒ±≈üsa -->
  <div id="fileUploadSection" class="hidden">
    <h1>üìÇ MTechno - S√ºreli Dosya Y√ºkleme</h1>
    <p>Ho≈ü geldin, <span id="welcomeUserName"></span>!</p>

    <!-- Depolama ve Abonelik Bilgisi -->
    <div class="storage-info">
      <div>üìä Kullanƒ±lan Depolama: <span id="storageUsed">0MB</span> / 100MB</div>
      <div class="storage-bar">
        <div class="storage-used" id="storageBar"></div>
      </div>
      <div id="subscriptionInfo" class="subscription-status">
        <!-- Abonelik bilgisi buraya gelecek -->
      </div>
    </div>

    <input type="file" id="fileInput" />
    <button id="uploadBtn">Dosya Y√ºkle</button>

    <p id="status"></p>

    <h2>üóÇÔ∏è Y√ºklediƒüin Dosyalar</h2>
    <ul id="fileList"></ul>
  </div>

  <script>
    // Firebase konfig√ºrasyonu
    const firebaseConfig = {
      apiKey: "AIzaSyDXbv4aK-PyVvfIcsaDK_wGK2taL7vqwmg",
      authDomain: "login-77be0.firebaseapp.com",
      projectId: "login-77be0",
      storageBucket: "login-77be0.firebasestorage.app",
      messagingSenderId: "631209373102",
      appId: "1:631209373102:web:11ba283b57b8d12fc02c3f"
    };

    // Firebase'i ba≈ülat
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Sabitler
    const MAX_USER_STORAGE = 100 * 1024 * 1024; // 100MB ki≈üi ba≈üƒ±
    const SUBSCRIPTION_DAYS = 30; // 30 g√ºn abonelik
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB max dosya (Firestore limiti)

    // DOM elementleri
    const loginPrompt = document.getElementById('loginPrompt');
    const fileUploadSection = document.getElementById('fileUploadSection');
    const userInfo = document.getElementById('userInfo');
    const userEmail = document.getElementById('userEmail');
    const welcomeUserName = document.getElementById('welcomeUserName');
    const status = document.getElementById('status');
    const fileList = document.getElementById('fileList');
    const storageUsed = document.getElementById('storageUsed');
    const storageBar = document.getElementById('storageBar');
    const subscriptionInfo = document.getElementById('subscriptionInfo');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    // Kullanƒ±cƒ± durumunu kontrol et
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        sessionStorage.setItem('userLoggedIn', 'true');
        sessionStorage.setItem('userEmail', user.email);
        sessionStorage.setItem('userUID', user.uid);
        
        const userDoc = await db.collection('users').doc(user.uid).get();
        const userData = userDoc.data();
        
        loginPrompt.classList.add('hidden');
        fileUploadSection.classList.remove('hidden');
        userInfo.classList.remove('hidden');
        
        userEmail.textContent = user.email;
        welcomeUserName.textContent = userData?.name || user.email;
        
        await checkSubscription();
        await loadFiles();
        await updateStorageInfo();

      } else {
        sessionStorage.removeItem('userLoggedIn');
        sessionStorage.removeItem('userEmail');
        sessionStorage.removeItem('userUID');
        
        loginPrompt.classList.remove('hidden');
        fileUploadSection.classList.add('hidden');
        userInfo.classList.add('hidden');
      }
    });

    // Abonelik kontrol√º
    async function checkSubscription() {
      const user = auth.currentUser;
      if (!user) return;

      const userDoc = await db.collection('users').doc(user.uid).get();
      const userData = userDoc.data();

      let subscriptionEnd = userData?.subscriptionEnd;
      
      if (!subscriptionEnd) {
        subscriptionEnd = new Date();
        subscriptionEnd.setDate(subscriptionEnd.getDate() + SUBSCRIPTION_DAYS);
        
        await db.collection('users').doc(user.uid).update({
          subscriptionEnd: subscriptionEnd
        });
        
        status.textContent = "üéâ Ho≈ü geldiniz! 30 g√ºnl√ºk √ºcretsiz aboneliƒüiniz ba≈üladƒ±.";
      } else {
        subscriptionEnd = new Date(subscriptionEnd.seconds * 1000);
      }

      const today = new Date();
      const timeDiff = subscriptionEnd - today;
      const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

      updateSubscriptionDisplay(daysLeft);

      if (daysLeft <= 0) {
        await deleteExpiredFiles();
      }
    }

    function updateSubscriptionDisplay(daysLeft) {
      if (daysLeft > 10) {
        subscriptionInfo.className = 'subscription-status subscription-good';
        subscriptionInfo.innerHTML = `‚úÖ Aboneliƒüiniz <strong>${daysLeft}</strong> g√ºn daha ge√ßerli`;
      } else if (daysLeft > 3) {
        subscriptionInfo.className = 'subscription-status subscription-warning';
        subscriptionInfo.innerHTML = `‚ö†Ô∏è Aboneliƒüiniz <strong>${daysLeft}</strong> g√ºn sonra bitiyor`;
      } else if (daysLeft > 0) {
        subscriptionInfo.className = 'subscription-status subscription-critical';
        subscriptionInfo.innerHTML = `
          üö® Aboneliƒüiniz <strong>${daysLeft}</strong> g√ºn sonra bitiyor!
          <br>
          <button class="extend-btn" onclick="extendSubscription()">
            üîÑ S√ºreyi 1 Ay Uzat
          </button>
        `;
      } else {
        subscriptionInfo.className = 'subscription-status subscription-critical';
        subscriptionInfo.innerHTML = `‚ùå Aboneliƒüiniz sona erdi. Yeni dosya y√ºkleyemezsiniz.`;
      }
    }

    // Aboneliƒüi uzat
    async function extendSubscription() {
      const user = auth.currentUser;
      if (!user) return;

      const newEndDate = new Date();
      newEndDate.setDate(newEndDate.getDate() + SUBSCRIPTION_DAYS);

      await db.collection('users').doc(user.uid).update({
        subscriptionEnd: newEndDate
      });

      status.textContent = "‚úÖ Aboneliƒüiniz 1 ay uzatƒ±ldƒ±!";
      await checkSubscription();
    }

    // S√ºresi dolan dosyalarƒ± sil
    async function deleteExpiredFiles() {
      const user = auth.currentUser;
      if (!user) return;

      const snapshot = await db.collection('userFiles')
        .where('userId', '==', user.uid)
        .get();

      const deletePromises = [];
      snapshot.forEach(doc => {
        deletePromises.push(doc.ref.delete());
      });

      await Promise.all(deletePromises);
      status.textContent = "‚ÑπÔ∏è S√ºresi dolan dosyalarƒ±nƒ±z temizlendi.";
      await loadFiles();
      await updateStorageInfo();
    }

    // T√ºrk√ße karakterleri temizle
    function sanitizeFileName(name) {
      return name
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[√ß√áƒüƒûƒ±ƒ∞√∂√ñ≈ü≈û√º√ú]/g, c =>
          ({ √ß: "c", √á: "C", ƒü: "g", ƒû: "G", ƒ±: "i", ƒ∞: "I", √∂: "o", √ñ: "O", ≈ü: "s", ≈û: "S", √º: "u", √ú: "U" }[c])
        )
        .replace(/\s+/g, "_")
        .replace(/[^a-zA-Z0-9_.-]/g, "");
    }

    // Kullanƒ±cƒ±nƒ±n toplam depolama kullanƒ±mƒ±nƒ± hesapla
    async function getUserStorageUsage() {
      const user = auth.currentUser;
      if (!user) return 0;

      const snapshot = await db.collection('userFiles')
        .where('userId', '==', user.uid)
        .get();

      let totalSize = 0;
      snapshot.forEach(doc => {
        totalSize += doc.data().size || 0;
      });

      return totalSize;
    }

    // Depolama bilgisini g√ºncelle
    async function updateStorageInfo() {
      const usedBytes = await getUserStorageUsage();
      const usedMB = (usedBytes / 1024 / 1024).toFixed(1);
      const percentage = (usedBytes / MAX_USER_STORAGE) * 100;

      storageUsed.textContent = `${usedMB}MB`;
      storageBar.style.width = `${Math.min(percentage, 100)}%`;

      if (percentage > 90) {
        storageBar.style.background = '#ff4757';
      } else if (percentage > 70) {
        storageBar.style.background = '#ffa502';
      } else {
        storageBar.style.background = '#00d084';
      }
    }

    // ‚≠ê‚≠ê YENƒ∞ Sƒ∞STEM: BASE64 ƒ∞LE FIRESTORE'A KAYDET ‚≠ê‚≠ê
    document.getElementById("uploadBtn").addEventListener("click", async () => {
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];
      const uploadBtn = document.getElementById("uploadBtn");

      if (!file) {
        status.textContent = "‚ö†Ô∏è L√ºtfen bir dosya se√ßin.";
        return;
      }

      // Dosya boyutu kontrol√º (10MB limit)
      if (file.size > MAX_FILE_SIZE) {
        status.textContent = "‚ùå Dosya boyutu 10MB'dan k√º√ß√ºk olmalƒ±dƒ±r.";
        return;
      }

      // Abonelik kontrol√º
      const user = auth.currentUser;
      const userDoc = await db.collection('users').doc(user.uid).get();
      const subscriptionEnd = new Date(userDoc.data().subscriptionEnd.seconds * 1000);
      const today = new Date();
      
      if (subscriptionEnd <= today) {
        status.textContent = "‚ùå Aboneliƒüiniz sona erdi. L√ºtfen s√ºreyi uzatƒ±n.";
        return;
      }

      // Depolama kontrol√º
      const currentUsage = await getUserStorageUsage();
      const remainingSpace = MAX_USER_STORAGE - currentUsage;

      if (file.size > remainingSpace) {
        const remainingMB = (remainingSpace / 1024 / 1024).toFixed(1);
        status.textContent = `‚ùå Yetersiz depolama alanƒ±! Kalan: ${remainingMB}MB`;
        return;
      }

      // Y√ºkleme ba≈ülƒ±yor
      status.textContent = "‚è≥ Y√ºkleniyor...";
      uploadBtn.disabled = true;
      progressContainer.classList.remove('hidden');

      const safeName = sanitizeFileName(file.name);

      try {
        console.log("üì§ Base64 encoding ba≈ülƒ±yor:", file.name);

        // ‚≠ê GER√áEK PROGRESS BAR - FileReader ile ‚≠ê
        let progress = 0;
        const updateProgress = () => {
          progress += 10;
          if (progress > 90) progress = 90;
          
          progressFill.style.width = `${progress}%`;
          progressText.textContent = `${progress}%`;
          status.textContent = `‚è≥ Y√ºkleniyor... ${progress}%`;
        };

        const progressInterval = setInterval(updateProgress, 200);

        // FileReader ile base64'e √ßevir
        const fileData = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          
          reader.onload = (e) => {
            clearInterval(progressInterval);
            progressFill.style.width = '100%';
            progressText.textContent = '100%';
            status.textContent = "‚è≥ Firestore'a kaydediliyor...";
            resolve(e.target.result);
          };
          
          reader.onerror = (e) => {
            clearInterval(progressInterval);
            reject(new Error('Dosya okuma hatasƒ±'));
          };
          
          reader.onprogress = (e) => {
            if (e.lengthComputable) {
              const percent = (e.loaded / e.total) * 100;
              progressFill.style.width = `${percent}%`;
              progressText.textContent = `${Math.round(percent)}%`;
              status.textContent = `‚è≥ Y√ºkleniyor... ${Math.round(percent)}%`;
            }
          };
          
          reader.readAsDataURL(file);
        });

        console.log("‚úÖ Base64 encoding tamamlandƒ±");

        // Dosya s√ºresini abonelik biti≈üine ayarla
        const expiryDate = new Date(subscriptionEnd);

        // ‚≠ê FIRESTORE'A KAYDET - base64 data ile ‚≠ê
        await db.collection('userFiles').doc().set({
          userId: user.uid,
          fileName: safeName,
          originalName: file.name,
          fileData: fileData, // Base64 data
          size: file.size,
          uploadedAt: new Date(),
          expiryDate: expiryDate,
          contentType: file.type
        });

        console.log("üíæ Firestore kaydƒ± tamamlandƒ±");
        
        // Ba≈üarƒ± mesajƒ±
        status.textContent = "‚úÖ Dosya ba≈üarƒ±yla y√ºklendi!";
        fileInput.value = '';
        
        // Listeyi ve depolama bilgisini g√ºncelle
        await loadFiles();
        await updateStorageInfo();

      } catch (error) {
        console.error('‚ùå Y√ºkleme hatasƒ±:', error);
        status.textContent = "‚ùå Y√ºkleme hatasƒ±: " + error.message;
      } finally {
        // Temizlik
        uploadBtn.disabled = false;
        setTimeout(() => {
          progressContainer.classList.add('hidden');
          progressFill.style.width = '0%';
          progressText.textContent = '0%';
        }, 1000);
      }
    });

    // Dosyalarƒ± listele - YENƒ∞ VERSƒ∞YON
    async function loadFiles() {
      const user = auth.currentUser;
      if (!user) return;

      fileList.innerHTML = "‚è≥ Dosyalar y√ºkleniyor...";

      try {
        const snapshot = await db.collection('userFiles')
          .where('userId', '==', user.uid)
          .orderBy('uploadedAt', 'desc')
          .get();

        if (snapshot.empty) {
          fileList.innerHTML = "<li>Hen√ºz dosya y√ºklenmemi≈ü.</li>";
          return;
        }

        fileList.innerHTML = "";
        
        for (const doc of snapshot.docs) {
          const fileData = doc.data();
          const li = document.createElement("li");
          
          const fileSize = (fileData.size / 1024 / 1024).toFixed(2);
          const uploadDate = new Date(fileData.uploadedAt.seconds * 1000).toLocaleDateString('tr-TR');
          
          const expiryDate = new Date(fileData.expiryDate.seconds * 1000);
          const today = new Date();
          const daysLeft = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
          
          const daysLeftText = daysLeft > 0 ? `${daysLeft} g√ºn kaldƒ±` : 'S√ºresi doldu';
          const daysLeftClass = daysLeft > 7 ? 'subscription-good' : 
                               daysLeft > 3 ? 'subscription-warning' : 'subscription-critical';
          
          // ‚≠ê YENƒ∞: Base64 data'dan download linki olu≈ütur
          const downloadUrl = fileData.fileData;
          
          li.innerHTML = `
            <div>
              <a href="${downloadUrl}" target="_blank" download="${fileData.originalName}">
                ${fileData.originalName}
              </a>
              <br>
              <small>${fileSize} MB - ${uploadDate}</small>
              <br>
              <small class="${daysLeftClass}">‚è≥ ${daysLeftText}</small>
            </div>
            <div class="file-actions">
              <button class="delete-btn" onclick="deleteFile('${doc.id}')">Sil</button>
            </div>
          `;
          fileList.appendChild(li);
        }

      } catch (error) {
        console.error('Listeleme hatasƒ±:', error);
        fileList.innerHTML = "‚ùå Dosyalar y√ºklenirken hata olu≈ütu.";
      }
    }

    // Dosya silme - YENƒ∞ VERSƒ∞YON
    async function deleteFile(docId) {
      if (!confirm('Bu dosyayƒ± silmek istediƒüinizden emin misiniz?')) {
        return;
      }

      try {
        await db.collection('userFiles').doc(docId).delete();
        
        status.textContent = "‚úÖ Dosya silindi.";
        await loadFiles();
        await updateStorageInfo();
        
      } catch (error) {
        console.error('Silme hatasƒ±:', error);
        status.textContent = "‚ùå Dosya silinirken hata olu≈ütu.";
      }
    }

    // √áƒ±kƒ±≈ü yap
    function logout() {
      auth.signOut();
    }

    // Sayfa y√ºklendiƒüinde session kontrol√º
    document.addEventListener('DOMContentLoaded', function() {
      if (sessionStorage.getItem('userLoggedIn') === 'true') {
        console.log('Session mevcut, Firebase state bekleniyor...');
      }
    });
  </script>
</body>
</html>
